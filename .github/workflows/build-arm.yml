name: Build Arm image files
on:
  workflow_dispatch:
    inputs:
      host:
        description: "填写需要编译的host"
        required: true
        default: "oracle-arm"
        type: string

env:
  NIX_PATH: nixpkgs=channel:nixos-unstable
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Delete older workflow runs and artifacts
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 3
          keep_minimum_runs: 3

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: false

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: SSH Private Key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Install nixFlake
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            trusted-public-keys = zenqy.cachix.org-1:G5csLBsu/kQIOXU7XUiqeMacwzN1WQWv0+GysTVmJgo= cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=
            substituters = https://zenqy.cachix.org/ https://cache.nixos.org/
            system-features = nixos-test benchmark big-parallel kvm

      - name: Run Nix Flake Update
        run: nix flake update

      - name: Commit and Push
        run: |
          if [[ $(git diff flake.lock | wc -l) > 0 ]]; then
            git config --global user.name 'github-actions[bot]'
            git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
            git add flake.lock
            git commit -m "Update flake.lock - Automated Commit"
            git push
          fi

      - name: build image
        run: |
          nix build .#${{ inputs.host }}
          cp result/${{ inputs.host }}.raw ./${{ inputs.host }}.raw
          chmod 0644 ${{ inputs.host }}.raw
          gzip ${{ inputs.host }}.raw

      - name: Upload Image To Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          removeArtifacts: true
          tag: v${{ env.DATE }}
          artifacts: "${{ inputs.host }}.raw.gz"
          body: |
            Device:${{ inputs.host }}

      - name: Remove old Releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        if: success()
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ github.token }}
